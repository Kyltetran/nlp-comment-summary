<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>YouTube Comment Summarizer</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <link rel="stylesheet" href="/static/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <header>
       <h1>YouTube Comment Summarizer</h1>
    </header>

    <div class="form-container">
       <form id="youtube-form" class="form">
          <input type="text" id="youtube-url" name="youtube_url" placeholder="Paste the YouTube link here..." required>
          <button type="submit" class="start-button">Start</button>
       </form>
    </div>

    <div id="loading" class="loading-container" style="display: none;">
       <div class="loading-spinner"></div>
       <p>Analyzing comments... This may take a few minutes.</p>
    </div>

    <div class="tabs" id="results-container" style="display: none;">
       <input class="input" name="tabs" type="radio" id="tab-1" checked="checked"/>
       <label class="label" for="tab-1">Summarizer</label>
       <div class="panel">
          <h2>Comment Summary</h2>
          <div id="summary-content" class="content-area"></div>
       </div>

       <input class="input" name="tabs" type="radio" id="tab-2"/>
       <label class="label" for="tab-2">Sentiment Analysis</label>
       <div class="panel">
          <h2>Sentiment Analysis</h2>
          <div class="sentiment-container">
             <div class="sentiment-chart">
                <img id="sentiment-chart" src="" alt="Sentiment Analysis Chart">
             </div>
             <div id="sentiment-summary" class="content-area"></div>
          </div>
       </div>

       <input class="input" name="tabs" type="radio" id="tab-3"/>
       <label class="label" for="tab-3">Word Cloud</label>
       <div class="panel">
          <h2>Word Cloud</h2>
          <div class="wordcloud-container">
             <img id="wordcloud-image" src="" alt="Word Cloud">
          </div>
       </div>

       <input class="input" name="tabs" type="radio" id="tab-4"/>
       <label class="label" for="tab-4">Ask Questions</label>
       <div class="panel">
          <h2>Ask Questions About Comments</h2>
          <div class="ask-more-container">
             <p class="tip">Ask specific questions about the video comments. For example:</p>
             <ul class="examples-list">
                <li>What do viewers like most about this video?</li>
                <li>What criticisms do people have?</li>
                <li>What questions do people ask in the comments?</li>
                <li>What common themes appear in the comments?</li>
             </ul>
             <textarea id="question" placeholder="Ask a specific question about the comments..."></textarea>
             <div class="advanced-options">
                <label class="k-slider-label" title="Higher values include more comments but may be slower">Comment sample size: <span id="k-value">Auto</span></label>
                <input type="range" id="k-slider" min="0" max="400" value="0" title="0 = Automatic, higher values include more comments but may be slower">
             </div>
             <button id="ask-button" class="ask-button">Ask</button>
             <div id="qa-loading" class="loading-container" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Finding answer in comments...</p>
             </div>
             <div id="answer-stats" class="stats-area" style="display: none;"></div>
             <div id="answer-content" class="content-area" style="display: none;"></div>
          </div>
       </div>
    </div>
    <script>
       document.addEventListener('DOMContentLoaded', function() {
          const form = document.getElementById('youtube-form');
          const loadingIndicator = document.getElementById('loading');
          const resultsContainer = document.getElementById('results-container');
          const askButton = document.getElementById('ask-button');
          const qaLoadingIndicator = document.getElementById('qa-loading');
          const answerContent = document.getElementById('answer-content');
          const answerStats = document.getElementById('answer-stats');
          const kSlider = document.getElementById('k-slider');
          const kValue = document.getElementById('k-value');
          let currentVideoId = null;

          // Handle k-slider changes
          kSlider.addEventListener('input', function() {
             const val = parseInt(this.value);
             kValue.textContent = val === 0 ? "Auto" : val;
          });

          form.addEventListener('submit', function(e) {
             e.preventDefault();

             // Show loading indicator
             loadingIndicator.style.display = 'flex';
             resultsContainer.style.display = 'none';
             answerContent.style.display = 'none';
             answerStats.style.display = 'none';

             // Get the YouTube URL
             const youtubeUrl = document.getElementById('youtube-url').value;

             // Call the backend
             analyzeYouTubeComments(youtubeUrl);
          });

          askButton.addEventListener('click', function() {
             const question = document.getElementById('question').value;
             if (question.trim() !== '') {
                // Show loading indicator
                qaLoadingIndicator.style.display = 'flex';
                answerContent.style.display = 'none';
                answerStats.style.display = 'none';

                // Get k value from slider (0 means auto)
                const kVal = parseInt(kSlider.value);
                const k = kVal === 0 ? null : kVal;

                // Call the backend to answer the question
                askQuestion(question, k);
             }
          });

          // Function to call the backend API
          function analyzeYouTubeComments(youtubeUrl) {
             // Call the backend API
             fetch('/api/analyze', {
                method: 'POST',
                headers: {
                   'Content-Type': 'application/json',
                },
                body: JSON.stringify({ youtube_url: youtubeUrl }),
             })
             .then(response => {
                if (!response.ok) {
                   throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
             })
             .then(data => {
                // Store video ID for later use
                currentVideoId = data.video_id;

                // Process the response data
                displayResults(data);
             })
             .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while analyzing the comments: ' + error.message);
                loadingIndicator.style.display = 'none';
             });
          }

          // Function to display the results
          function displayResults(data) {
             // Hide loading indicator
             loadingIndicator.style.display = 'none';

             // Show results container
             resultsContainer.style.display = 'flex';

             // Update the summary tab
             document.getElementById('summary-content').innerHTML = formatParagraphs(data.overall_summary);

             // Update the sentiment analysis tab
             document.getElementById('sentiment-chart').src = data.output_files.sentiment_chart + '?t=' + new Date().getTime();
             document.getElementById('sentiment-summary').innerHTML = `
             <div class="summary-section">
             <strong>Positive Aspects:</strong><br>
             ${formatBullets(data.positive_summary)}
             <br><strong>Negative Aspects:</strong><br>
             ${formatBullets(data.negative_summary)}
             </div>
             `;

             // Update the word cloud tab
             document.getElementById('wordcloud-image').src = data.output_files.wordcloud + '?t=' + new Date().getTime();

             // Clear any previous Q&A results
             document.getElementById('question').value = '';
             answerContent.innerHTML = '';
             answerContent.style.display = 'none';
             answerStats.style.display = 'none';
          }

          function formatBullets(text) {
             if (!text) return '';
             return text
                .split('\n')
                .filter(line => line.trim() !== '')
                .map(line => `<div class="bullet-line">   ${line.trim().replace(/^\*+/, '').trim()}</div>`)
                .join('');
          }

          function formatParagraphs(text) {
             if (!text) return '';
             return text
                .split(/\n\s*\n/) // split by empty lines or double newlines
                .filter(p => p.trim() !== '')
                .map(p => `<p>${p.trim()}</p>`)
                .join('');
          }

          // Function to ask additional questions
          function askQuestion(question, k = null) {
             // Prepare request payload
             const payload = { question: question };
             if (k !== null) {
                payload.k = k;
             }

             fetch('/api/ask', {
                method: 'POST',
                headers: {
                   'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
             })
             .then(response => {
                if (!response.ok) {
                   throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
             })
             .then(data => {
                // Hide loading indicator
                qaLoadingIndicator.style.display = 'none';

                // Display processing stats if available
                if (data.processing_time) {
                   answerStats.innerHTML = `<span class="processing-time">Processing time: ${data.processing_time}</span>`;
                   answerStats.style.display = 'block';
                }

                // Display the answer
                answerContent.innerHTML = formatParagraphs(data.answer);
                answerContent.style.display = 'block';
             })
             .catch(error => {
                console.error('Error:', error);
                qaLoadingIndicator.style.display = 'none';

                // Show error message in the answer content area
                answerContent.innerHTML = `<p class="error-message">Error: ${error.message}. Please try again or reload the page.</p>`;
                answerContent.style.display = 'block';
             });
          }

          // Check database status on page load
          fetch('/api/status')
            .then(response => response.json())
            .then(data => {
               if (data.database_exists && data.current_video_id) {
                  console.log(`Database exists for video ID: ${data.current_video_id}`);

                  if (data.metadata && data.metadata.comment_count) {
                     // Set max value for k-slider based on comment count
                     const maxK = Math.min(Math.max(data.metadata.comment_count, 100), 400);
                     kSlider.max = maxK;
                     console.log(`Set max k value to ${maxK} based on ${data.metadata.comment_count} comments`);
                  }
               }
            })
            .catch(err => console.error('Error checking database status:', err));
       });
    </script>
</body>
</html>
