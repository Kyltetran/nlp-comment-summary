<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>YouTube Comment Summarizer</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <link rel="stylesheet" href="/static/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <header>
       <h1>YouTube Comment Summarizer</h1>
    </header>

    <div class="form-container">
       <form id="youtube-form" class="form">
          <input type="text" id="youtube-url" name="youtube_url" placeholder="Paste the YouTube link here..." required>
          <button type="submit" class="start-button">Start</button>
       </form>
    </div>

    <div id="loading" class="loading-container" style="display: none;">
       <div class="loading-spinner"></div>
       <p>Analyzing comments... This may take a few minutes.</p>
    </div>

    <div class="tabs" id="results-container" style="display: none;">
       <input class="input" name="tabs" type="radio" id="tab-1" checked="checked"/>
       <label class="label" for="tab-1">Summarizer</label>
       <div class="panel">
          <h2>Comment Summary</h2>
          <div id="summary-content" class="content-area"></div>
       </div>

       <input class="input" name="tabs" type="radio" id="tab-2"/>
       <label class="label" for="tab-2">Sentiment Analysis</label>
       <div class="panel">
          <h2>Sentiment Analysis</h2>
          <div class="sentiment-container">
             <div class="sentiment-chart">
                <img id="sentiment-chart" src="" alt="Sentiment Analysis Chart">
             </div>
             <div id="sentiment-summary" class="content-area"></div>
          </div>
       </div>

       <input class="input" name="tabs" type="radio" id="tab-3"/>
       <label class="label" for="tab-3">Word Cloud</label>
       <div class="panel">
          <h2>Word Cloud</h2>
          <div class="wordcloud-container">
             <img id="wordcloud-image" src="" alt="Word Cloud">
          </div>
       </div>

       <input class="input" name="tabs" type="radio" id="tab-4"/>
       <label class="label" for="tab-4">Ask Questions</label>
       <div class="panel">
          <h2>Ask Questions About Comments</h2>
          <div class="ask-more-container">
             <textarea id="question" placeholder="Ask a specific question about the comments..."></textarea>
             <button id="ask-button" class="ask-button">Ask</button>
             <div id="qa-loading" class="loading-container" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Finding answer in comments...</p>
             </div>
             <div id="answer-content" class="content-area" style="display: none;"></div>
          </div>
       </div>
    </div>
    <script>
       document.addEventListener('DOMContentLoaded', function() {
          const form = document.getElementById('youtube-form');
          const loadingIndicator = document.getElementById('loading');
          const resultsContainer = document.getElementById('results-container');
          const askButton = document.getElementById('ask-button');
          const qaLoadingIndicator = document.getElementById('qa-loading');
          const answerContent = document.getElementById('answer-content');
          let currentVideoId = null;

          form.addEventListener('submit', function(e) {
             e.preventDefault();

             // Show loading indicator
             loadingIndicator.style.display = 'flex';
             resultsContainer.style.display = 'none';
             answerContent.style.display = 'none';

             // Get the YouTube URL
             const youtubeUrl = document.getElementById('youtube-url').value;

             // Call the backend
             analyzeYouTubeComments(youtubeUrl);
          });

          askButton.addEventListener('click', function() {
             const question = document.getElementById('question').value;
             if (question.trim() !== '') {
                // Show loading indicator
                qaLoadingIndicator.style.display = 'flex';
                answerContent.style.display = 'none';

                // Call the backend to answer the question
                askQuestion(question);
             }
          });

          // Function to call the backend API
          function analyzeYouTubeComments(youtubeUrl) {
             // Simulating backend call to python script
             console.log("Calling: python youtube_summary_tool.py " + youtubeUrl);

             // Real implementation using fetch
             fetch('/api/analyze', {
                method: 'POST',
                headers: {
                   'Content-Type': 'application/json',
                },
                body: JSON.stringify({ youtube_url: youtubeUrl }),
             })
             .then(response => response.json())
             .then(data => {
                // Store video ID for later use
                currentVideoId = data.video_id;

                // Process the response data
                displayResults(data);
             })
             .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while analyzing the comments.');
                loadingIndicator.style.display = 'none';
             });
          }

          // Function to display the results
          function displayResults(data) {
             // Hide loading indicator
             loadingIndicator.style.display = 'none';

             // Show results container
             resultsContainer.style.display = 'flex';

             // Update the summary tab
             document.getElementById('summary-content').innerHTML = formatParagraphs(data.overall_summary);

             // Update the sentiment analysis tab
             document.getElementById('sentiment-chart').src = data.output_files.sentiment_chart + '?t=' + new Date().getTime();
             document.getElementById('sentiment-summary').innerHTML = `
             <div class="summary-section">
             <strong>Positive Aspects:</strong><br>
             ${formatBullets(data.positive_summary)}
             <br><strong>Negative Aspects:</strong><br>
             ${formatBullets(data.negative_summary)}
             </div>
             `;

             // Update the word cloud tab
             document.getElementById('wordcloud-image').src = data.output_files.wordcloud + '?t=' + new Date().getTime();

             // Clear any previous Q&A results
             document.getElementById('question').value = '';
             answerContent.innerHTML = '';
             answerContent.style.display = 'none';
          }

          function formatBullets(text) {
             return text
                .split('\n')
                .filter(line => line.trim() !== '')
                .map(line => `<div class="bullet-line">   ${line.trim().replace(/^\*+/, '').trim()}</div>`)
                .join('');
          }

          function formatParagraphs(text) {
             return text
                .split(/\n\s*\n/) // split by empty lines or double newlines
                .filter(p => p.trim() !== '')
                .map(p => `<p>${p.trim()}</p>`)
                .join('');
          }

          // Function to ask additional questions
          function askQuestion(question) {
             fetch('/api/ask', {
                method: 'POST',
                headers: {
                   'Content-Type': 'application/json',
                },
                body: JSON.stringify({ question: question }),
             })
             .then(response => response.json())
             .then(data => {
                // Hide loading indicator
                qaLoadingIndicator.style.display = 'none';

                // Display the answer
                answerContent.innerHTML = formatParagraphs(data.answer);
                answerContent.style.display = 'block';
             })
             .catch(error => {
                console.error('Error:', error);
                qaLoadingIndicator.style.display = 'none';
                alert('An error occurred while processing your question.');
             });
          }
       });
    </script>
</body>
</html>
